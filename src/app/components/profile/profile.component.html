<div class="profile-container">
  <div class="profile-content">
    <ng-container *ngIf="userProfile$ | async as userProfile">
      <div class="profile-header">
        <div class="profile-avatar-container">
          <img [src]="userProfile.photoURL || 'assets/user-baseImg.png'" 
               alt="Profile Picture" 
               class="profile-avatar"
               [style.background-image]="getRankGradient(userProfile.rank)">
          <label for="file-upload" class="custom-file-upload">
            <mat-icon>camera_alt</mat-icon>
          </label>
          <input id="file-upload" type="file" (change)="onFileSelected($event)" accept="image/*">
        </div>
        <h1 class="profile-name">{{ userProfile.firstName }} {{ userProfile.lastName }}</h1>
        <p class="profile-username">{{ userProfile.username }}</p>
      </div>

      <mat-tab-group animationDuration="300ms" class="profile-tabs" mat-align-tabs="center">
        <mat-tab label="Profile">
          <div class="profile-info">
            <div class="info-item">
              <mat-icon>person</mat-icon>
              <span>{{ userProfile.firstName }} {{ userProfile.lastName }}</span>
            </div>
            <div class="info-item">
              <mat-icon>account_circle</mat-icon>
              <span>{{ userProfile.username }}</span>
            </div>
            <div class="info-item">
              <mat-icon>email</mat-icon>
              <span>{{ userProfile.email }}</span>
            </div>
            <div class="info-item">
              <mat-icon>public</mat-icon>
              <span>{{ userProfile.country || 'Not specified' }}</span>
            </div>
            <div class="info-item">
              <mat-icon>cake</mat-icon>
              <span>{{ formatDate(userProfile.dob) }}</span>
            </div>
          </div>

          <div class="profile-actions">
            <button mat-raised-button color="primary" (click)="toggleEditMode()">
              <mat-icon>edit</mat-icon> Edit Profile
            </button>
            <button mat-raised-button color="accent" (click)="toggleChangePasswordMode()">
              <mat-icon>lock</mat-icon> Change Password
            </button>
          </div>

          <form *ngIf="isEditMode" [formGroup]="editForm" (ngSubmit)="saveProfile()" class="edit-form">
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>First Name</mat-label>
                <input matInput formControlName="firstName" required>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Last Name</mat-label>
                <input matInput formControlName="lastName" required>
              </mat-form-field>
            </div>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Username</mat-label>
                <input matInput formControlName="username" required>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Country</mat-label>
                <input matInput formControlName="country">
              </mat-form-field>
            </div>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Date of Birth</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="dob">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </div>
            <div class="form-actions">
              <button mat-button (click)="toggleEditMode()">Cancel</button>
              <button mat-raised-button color="primary" type="submit" [disabled]="editForm.invalid">Save Changes</button>
            </div>
          </form>

          <form *ngIf="isChangePasswordMode" [formGroup]="changePasswordForm" (ngSubmit)="changePassword()" class="change-password-form">
            <mat-form-field appearance="outline">
              <mat-label>Current Password</mat-label>
              <input matInput formControlName="currentPassword" type="password" required>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>New Password</mat-label>
              <input matInput formControlName="newPassword" type="password" required>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Confirm New Password</mat-label>
              <input matInput formControlName="confirmPassword" type="password" required>
            </mat-form-field>
            <div class="form-actions">
              <button mat-button (click)="toggleChangePasswordMode()">Cancel</button>
              <button mat-raised-button color="primary" type="submit" [disabled]="changePasswordForm.invalid">Change Password</button>
            </div>
          </form>
        </mat-tab>

        <mat-tab label="Achievements">
          <div class="achievements-grid">
            <ng-container *ngIf="(achievements$ | async) as achievements">
              <div *ngFor="let achievement of achievements" class="achievement-card">
                <mat-icon>{{achievement.icon}}</mat-icon>
                <h3>{{achievement.name}}</h3>
                <p>{{achievement.description}}</p>
                <span class="achievement-date">Unlocked: {{formatDate(achievement.unlockedAt)}}</span>
              </div>
              <div *ngIf="achievements.length === 0" class="no-achievements">
                <p>No achievements unlocked yet. Keep rating beers to earn achievements!</p>
              </div>
            </ng-container>
          </div>
        </mat-tab>
a
        <mat-tab label="Statistics">
          <div class="statistics-container">
            <h2>Your Beer Journey</h2>
            <div class="statistic-item">
              <span>Total Beers Rated</span>
              <span>{{userProfile.statistics.totalBeersRated || 0}}</span>
            </div>
            <div class="statistic-item">
              <span>Countries Explored</span>
              <span>{{userProfile.statistics.countriesExplored.length || 0}}</span>
            </div>
            <div class="statistic-item">
              <span>Most Active Day</span>
              <span>{{userProfile.statistics.mostActiveDay.date || 'N/A'}} ({{userProfile.statistics.mostActiveDay.count || 0}} ratings)</span>
            </div>
            <div class="statistic-item">
              <span>Time on Platform</span>
              <span>{{calculateDaysSinceRegistration(userProfile.statistics.registrationDate) || 0}} days</span>
            </div>
            <div class="statistic-item">
              <span>Total Points</span>
              <span>{{userProfile.statistics.points || 0}}</span>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Rank">
          <div class="rank-container" *ngIf="userProfile.rank">
            <h2>Your Current Rank</h2>
            <div class="rank-card">
              <mat-icon>{{userProfile.rank.icon}}</mat-icon>
              <h3>{{userProfile.rank.name}}</h3>
              <p>Level {{userProfile.rank.level}}</p>
              <mat-progress-bar [value]="calculateRankProgress(userProfile.statistics.points, userProfile.rank)"></mat-progress-bar>
              <p>{{userProfile.statistics.points || 0}} / {{userProfile.rank.maxPoints}} points</p>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Favorite Beers">
      <div class="beer-grid">
        <ng-container *ngIf="(favoriteBeers$ | async) as favoriteBeers">
          <div *ngFor="let beer of favoriteBeers" class="beer-card">
            <img [src]="beer.beerLabelUrl" [alt]="beer.name">
            <div class="beer-info">
              <h3>{{beer.name}}</h3>
            </div>
            <button mat-icon-button class="remove-button" (click)="removeFavoriteBeer(beer.id)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </ng-container>
      </div>
    </mat-tab>

    <mat-tab label="Rated Beers">
      <div class="beer-grid">
        <ng-container *ngIf="(ratedBeers$ | async) as ratedBeers">
          <div *ngFor="let beer of ratedBeers" class="beer-card">
            <img [src]="beer.beerLabelUrl" [alt]="beer.name">
            <div class="beer-info">
              <h3>{{beer.name}}</h3>
              <!-- <p>{{beer.brewery}}</p> -->
              <div class="rating">
                <span class="rating-value">{{beer.rating | number:'1.1-1'}}</span>
                <span class="rating-date">{{formatDate(beer.ratedAt)}}</span>
              </div>
            </div>
            <button mat-icon-button class="remove-rating" (click)="removeRating(beer.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </ng-container>
      </div>
    </mat-tab>
  </mat-tab-group>

      <div class="profile-footer">
        <button mat-raised-button color="primary" (click)="openNewBeerModal()">
          <mat-icon>add</mat-icon> Request New Beer
        </button>
        <button mat-raised-button color="warn" (click)="signOut()">
          <mat-icon>exit_to_app</mat-icon> Logout
        </button>
      </div>
    </ng-container>
  </div>
</div>

<mat-progress-spinner *ngIf="isLoading" mode="indeterminate"></mat-progress-spinner>

